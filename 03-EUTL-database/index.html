
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.1.3">
    
    
      
        <title>Accounts - ETS-Watch</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.e35208c4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ef6f36e2.min.css">
        
          
          
          <meta name="theme-color" content="#000000">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="black" data-md-color-accent="">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#eu-transaction-log-database" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="ETS-Watch" class="md-header__button md-logo" aria-label="ETS-Watch" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ETS-Watch
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Accounts
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/OSUKED/ETS-Watch/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    ETS-Watch
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href=".." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../01-prices/" class="md-tabs__link md-tabs__link--active">
        Development
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="ETS-Watch" class="md-nav__button md-logo" aria-label="ETS-Watch" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    ETS-Watch
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/OSUKED/ETS-Watch/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    ETS-Watch
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      <label class="md-nav__link" for="__nav_2">
        Development
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Development" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Development
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../01-prices/" class="md-nav__link">
        Market Prices
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../02-installation-allocations/" class="md-nav__link">
        Installations
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Accounts
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Accounts
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#identifying-operator-holding-accounts" class="md-nav__link">
    Identifying Operator Holding Accounts
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#retrieving-installationoperator-data" class="md-nav__link">
    Retrieving Installation/Operator Data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#putting-it-all-together" class="md-nav__link">
    Putting It All Together
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#identifying-operator-holding-accounts" class="md-nav__link">
    Identifying Operator Holding Accounts
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#retrieving-installationoperator-data" class="md-nav__link">
    Retrieving Installation/Operator Data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#putting-it-all-together" class="md-nav__link">
    Putting It All Together
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/OSUKED/ETS-Watch/edit/main/docs/03-EUTL-database.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="eu-transaction-log-database">EU Transaction Log Database<a class="headerlink" href="#eu-transaction-log-database" title="Permanent link">&para;</a></h1>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>

<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span> <span class="k">as</span> <span class="n">bs</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">ipypb</span> <span class="kn">import</span> <span class="n">track</span>
<span class="kn">import</span> <span class="nn">FEAutils</span> <span class="k">as</span> <span class="nn">hlp</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">JSON</span>
</code></pre></div>
<p><br></p>
<h3 id="identifying-operator-holding-accounts">Identifying Operator Holding Accounts<a class="headerlink" href="#identifying-operator-holding-accounts" title="Permanent link">&para;</a></h3>
<p>We'll start by calling the first page of the unfiltered search</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="n">get_accounts_raw_search</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">page_num</span><span class="o">=</span><span class="mi">0</span><span class="p">:</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;https://ec.europa.eu/clima/ets/oha.do?form=oha&amp;languageCode=en&amp;accountHolder=&amp;installationIdentifier=&amp;installationName=&amp;permitIdentifier=&amp;mainActivityType=-1&amp;searchType=oha&amp;currentSortSettings=&amp;backList=%3CBack&amp;resultList.currentPageNumber=</span><span class="si">{</span><span class="n">page_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">r</span> <span class="o">=</span> <span class="n">get_accounts_raw_search</span><span class="p">()</span>

<span class="n">r</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&lt;Response [200]&gt;
</code></pre></div>
<p><br></p>
<p>For this single page we'll create a function that converts the relevant table into a dataframe</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">extract_search_df</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
    <span class="n">soup</span> <span class="o">=</span> <span class="n">bs</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="n">results_table</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;table&#39;</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;tblAccountSearchResult&#39;</span><span class="p">})</span>

    <span class="n">df_search</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span>
                 <span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">results_table</span><span class="p">))</span>
                 <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                 <span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                 <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                 <span class="o">.</span><span class="n">T</span>
                 <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                 <span class="o">.</span><span class="n">T</span>
                 <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                 <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                     <span class="s1">&#39;National Administrator&#39;</span><span class="p">:</span> <span class="s1">&#39;country&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;Account Type&#39;</span><span class="p">:</span> <span class="s1">&#39;account_type&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;Account Holder Name&#39;</span><span class="p">:</span> <span class="s1">&#39;account_holder_name&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;Installation/Aircraft ID&#39;</span><span class="p">:</span> <span class="s1">&#39;installation_or_aircraft_id&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;Installation Name/Aircraft Operator Code*&#39;</span><span class="p">:</span> <span class="s1">&#39;operator_code&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;Company Registration No&#39;</span><span class="p">:</span> <span class="s1">&#39;company_registration_number&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;Permit/Plan ID&#39;</span><span class="p">:</span> <span class="s1">&#39;permit_or_plan_id&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;Permit/Plan Date&#39;</span><span class="p">:</span> <span class="s1">&#39;permit_or_plan_date&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;Main Activity Type&#39;</span><span class="p">:</span> <span class="s1">&#39;main_activity_type&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;Latest Compliance Code&#39;</span><span class="p">:</span> <span class="s1">&#39;latest_compliance_code&#39;</span>
                 <span class="p">})</span>
                <span class="p">)</span>

    <span class="n">df_search</span><span class="p">[</span><span class="s1">&#39;account_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;accountID=&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">results_table</span><span class="o">.</span><span class="n">findAll</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;Details - All Phases&#39;</span><span class="p">))]</span>

    <span class="k">return</span> <span class="n">df_search</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">df_search</span> <span class="o">=</span> <span class="n">extract_search_df</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

<span class="n">df_search</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th align="right"></th>
<th align="left">country</th>
<th align="left">account_type</th>
<th align="left">account_holder_name</th>
<th align="right">installation_or_aircraft_id</th>
<th align="right">operator_code</th>
<th align="left">company_registration_number</th>
<th align="left">permit_or_plan_id</th>
<th align="left">permit_or_plan_date</th>
<th align="left">main_activity_type</th>
<th align="left">latest_compliance_code</th>
<th align="right">account_id</th>
</tr>
</thead>
<tbody>
<tr>
<td align="right">0</td>
<td align="left">Austria</td>
<td align="left">Aircraft Operator Account</td>
<td align="left">Jetalliance Flugbetriebs GmbH</td>
<td align="right">200103</td>
<td align="right">27702</td>
<td align="left">FN 203001g</td>
<td align="left">BMLFUW-UW.1.3.2/0354-V/4/2009</td>
<td align="left">2010-01-01</td>
<td align="left">Aircraft operator activities</td>
<td align="left">C</td>
<td align="right">90574</td>
</tr>
<tr>
<td align="right">1</td>
<td align="left">Austria</td>
<td align="left">Aircraft Operator Account</td>
<td align="left">Glock GmbH</td>
<td align="right">200108</td>
<td align="right">194</td>
<td align="left">FN64142b</td>
<td align="left">BMFLUW-UW.1.3.2/0084-V/4/2010</td>
<td align="left">2010-01-01</td>
<td align="left">Aircraft operator activities</td>
<td align="left">A</td>
<td align="right">90727</td>
</tr>
<tr>
<td align="right">2</td>
<td align="left">Austria</td>
<td align="left">Aircraft Operator Account</td>
<td align="left">Glock Services GmbH</td>
<td align="right">200109</td>
<td align="right">36057</td>
<td align="left">FN329154a</td>
<td align="left">UW.1.3.2/0085-V/4/2011</td>
<td align="left">2010-01-01</td>
<td align="left">Aircraft operator activities</td>
<td align="left">A</td>
<td align="right">90728</td>
</tr>
</tbody>
</table>
<p><br></p>
<p>We next need to identify how many pages we need to retrieve data from</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">get_num_operating_accounts_pages</span><span class="p">():</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">get_accounts_raw_search</span><span class="p">()</span>
    <span class="n">soup</span> <span class="o">=</span> <span class="n">bs</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

    <span class="n">soup_pn</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;resultList.lastPageNumber&#39;</span><span class="p">})</span>
    <span class="n">num_pages</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">soup_pn</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">num_pages</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">num_pages</span> <span class="o">=</span> <span class="n">get_num_operating_accounts_pages</span><span class="p">()</span>

<span class="n">num_pages</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>883
</code></pre></div>
<p><br></p>
<p>We're now ready to download and collate all of the separate pages</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">get_full_search_df</span><span class="p">(</span><span class="n">num_pages</span><span class="p">):</span>
    <span class="n">df_search</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">page_num</span> <span class="ow">in</span> <span class="n">track</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_pages</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Accounts&#39;</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">get_accounts_raw_search</span><span class="p">(</span><span class="n">page_num</span><span class="o">=</span><span class="n">page_num</span><span class="p">)</span>
        <span class="n">df_search_page</span> <span class="o">=</span> <span class="n">extract_search_df</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">df_search</span> <span class="o">=</span> <span class="n">df_search</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_search_page</span><span class="p">)</span>

    <span class="n">df_search</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_search</span>
                 <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                 <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
                <span class="p">)</span>

    <span class="k">return</span> <span class="n">df_search</span>

<span class="k">def</span> <span class="nf">get_search_df</span><span class="p">(</span><span class="n">data_dir</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">num_pages</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">num_pages</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">num_pages</span> <span class="o">=</span> <span class="n">get_num_operating_accounts_pages</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">redownload</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">df_search</span> <span class="o">=</span> <span class="n">get_full_search_df</span><span class="p">(</span><span class="n">num_pages</span><span class="p">)</span>
        <span class="n">df_search</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data_dir</span><span class="si">}</span><span class="s1">/account_search.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df_search</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data_dir</span><span class="si">}</span><span class="s1">/account_search.csv&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">redownload_search_df</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">df_search</span> <span class="o">=</span> <span class="n">get_search_df</span><span class="p">(</span><span class="n">data_dir</span><span class="o">=</span><span class="s1">&#39;../data&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="n">redownload_search_df</span><span class="p">)</span>

<span class="n">df_search</span><span class="o">.</span><span class="n">shape</span>
</code></pre></div>
<div><span class="Text-label" style="display:inline-block; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; min-width:0; max-width:15ex; vertical-align:middle; text-align:right"></span>
<progress style="width:60ex" max="883" value="883" class="Progress-main"/></progress>
<span class="Progress-label"><strong>100%</strong></span>
<span class="Iteration-label">880/883</span>
<span class="Time-label">[09:19<00:01, 0.63s/it]</span></div>

<div class="highlight"><pre><span></span><code>(17620, 11)
</code></pre></div>
<p><br></p>
<p>We would intuitively expect to see only unique values in the <code>permit_or_plan_id</code> column but we can see for values such as <code>EEW012</code> that this is not the case. In this instance it appears as though the account holder name has changed, meaning that the emissions data has been split despite it being owned by the same overarching company - these are problems we will have to address later.</p>
<div class="highlight"><pre><span></span><code><span class="n">df_search</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_search</span><span class="p">[</span><span class="s1">&#39;permit_or_plan_id&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;EEW012&#39;</span><span class="p">]</span>
</code></pre></div>
<table>
<thead>
<tr>
<th align="right"></th>
<th align="left">country</th>
<th align="left">account_type</th>
<th align="left">account_holder_name</th>
<th align="right">installation_or_aircraft_id</th>
<th align="left">operator_code</th>
<th align="left">company_registration_number</th>
<th align="left">permit_or_plan_id</th>
<th align="left">permit_or_plan_date</th>
<th align="left">main_activity_type</th>
<th align="left">latest_compliance_code</th>
<th align="right">account_id</th>
</tr>
</thead>
<tbody>
<tr>
<td align="right">137</td>
<td align="left">Austria</td>
<td align="left">Operator Holding Account</td>
<td align="left">VERBUND Thermal Power GmbH &amp; Co KG</td>
<td align="right">97</td>
<td align="left">Verbund KW Voitsberg</td>
<td align="left">FN 220426 g</td>
<td align="left">EEW012</td>
<td align="left">2004-01-02</td>
<td align="left">Combustion installations with a rated thermal ...</td>
<td align="left">C</td>
<td align="right">93794</td>
</tr>
<tr>
<td align="right">271</td>
<td align="left">Austria</td>
<td align="left">Operator Holding Account</td>
<td align="left">A-Tec Beteiligungs GmbH</td>
<td align="right">233</td>
<td align="left">DKW Voitsberg</td>
<td align="left">FN 294601 m</td>
<td align="left">EEW012</td>
<td align="left">2005-06-09</td>
<td align="left">Combustion installations with a rated thermal ...</td>
<td align="left">A</td>
<td align="right">93944</td>
</tr>
</tbody>
</table>
<p><br></p>
<p>We'll quickly inspect the number of each type of account</p>
<div class="highlight"><pre><span></span><code><span class="n">df_search</span><span class="p">[</span><span class="s1">&#39;account_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Operator Holding Account     16040
Aircraft Operator Account     1580
Name: account_type, dtype: int64
</code></pre></div>
<p><br></p>
<h3 id="retrieving-installationoperator-data">Retrieving Installation/Operator Data<a class="headerlink" href="#retrieving-installationoperator-data" title="Permanent link">&para;</a></h3>
<p>In this section we'll start looking at individual operator accounts and extracting some more detailed information </p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="n">account_id_to_url</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">account_id</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;https://ec.europa.eu/clima/ets/ohaDetails.do?accountID=</span><span class="si">{</span><span class="n">account_id</span><span class="si">}</span><span class="s1">&amp;action=all&#39;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">account_id</span> <span class="o">=</span> <span class="n">df_search</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_search</span><span class="p">[</span><span class="s1">&#39;account_type&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Aircraft Operator Account&#39;</span><span class="p">,</span> <span class="s1">&#39;account_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">account_url</span> <span class="o">=</span> <span class="n">account_id_to_url</span><span class="p">(</span><span class="n">account_id</span><span class="p">)</span>

<span class="n">account_url</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&#39;https://ec.europa.eu/clima/ets/ohaDetails.do?accountID=90574&amp;action=all&#39;
</code></pre></div>
<p><br></p>
<p>We'll create a function that extracts the relevant tables as Beautiful Soup objects</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">retry_request</span><span class="p">(</span><span class="n">root_url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{},</span> <span class="n">n_retries</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_retries</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">root_url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">r</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">e</span>
            <span class="k">continue</span>

    <span class="k">raise</span> <span class="n">err</span>

<span class="k">def</span> <span class="nf">extract_key_table_soups</span><span class="p">(</span><span class="n">account_url</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">retry_request</span><span class="p">(</span><span class="n">account_url</span><span class="p">)</span>
    <span class="n">soup</span> <span class="o">=</span> <span class="n">bs</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

    <span class="n">operator_master_table</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;table&#39;</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;summary&#39;</span><span class="p">:</span> <span class="s1">&#39;Master account details&#39;</span><span class="p">})</span>
    <span class="n">operator_child_table</span><span class="p">,</span> <span class="n">compliance_table</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">findAll</span><span class="p">(</span><span class="s1">&#39;table&#39;</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;summary&#39;</span><span class="p">:</span> <span class="s1">&#39;Child account details&#39;</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">operator_master_table</span><span class="p">,</span> <span class="n">operator_child_table</span><span class="p">,</span> <span class="n">compliance_table</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">operator_master_table</span><span class="p">,</span> <span class="n">operator_child_table</span><span class="p">,</span> <span class="n">compliance_table</span> <span class="o">=</span> <span class="n">extract_key_table_soups</span><span class="p">(</span><span class="n">account_url</span><span class="p">)</span>

<span class="nb">len</span><span class="p">(</span><span class="n">operator_master_table</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">operator_child_table</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">compliance_table</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(5, 5, 3)
</code></pre></div>
<p><br></p>
<p>The first table we'll extract is the time-series compliance data</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">try_convert</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">type_</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">type_</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">return</span> <span class="n">default</span>

<span class="n">filter_for_year_indexes</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">try_convert</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">extract_compliance_df</span><span class="p">(</span><span class="n">compliance_table</span><span class="p">):</span>
    <span class="n">df_compliance</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span>
                     <span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">compliance_table</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                     <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                     <span class="o">.</span><span class="n">T</span>
                     <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                     <span class="o">.</span><span class="n">T</span>
                     <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                     <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;EU ETS Phase&#39;</span><span class="p">,</span> <span class="s1">&#39;Cumulative Surrendered Units**&#39;</span><span class="p">,</span> <span class="s1">&#39;Cumulative Verified Emissions***&#39;</span><span class="p">])</span>
                     <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">)</span>
                     <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">filter_for_year_indexes</span><span class="p">)</span>
                     <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                         <span class="s1">&#39;Allowances in Allocation&#39;</span><span class="p">:</span> <span class="s1">&#39;allocated_allowances&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;Verified Emissions&#39;</span><span class="p">:</span> <span class="s1">&#39;verified_emissions&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;Units Surrendered&#39;</span><span class="p">:</span> <span class="s1">&#39;units_surrendered&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;Compliance Code&#39;</span><span class="p">:</span> <span class="s1">&#39;compliance_code&#39;</span>
                     <span class="p">})</span>
                    <span class="p">)</span>

    <span class="k">return</span> <span class="n">df_compliance</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">df_compliance</span> <span class="o">=</span> <span class="n">extract_compliance_df</span><span class="p">(</span><span class="n">compliance_table</span><span class="p">)</span>

<span class="n">df_compliance</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div>
<table>
<thead>
<tr>
<th align="right">('Unnamed: 0_level_0', 'Year')</th>
<th align="right">('allocated_allowances', 'Unnamed: 1_level_1')</th>
<th align="right">('verified_emissions', 'Unnamed: 2_level_1')</th>
<th align="right">('units_surrendered', 'Unnamed: 3_level_1')</th>
<th align="left">('compliance_code', 'Unnamed: 4_level_1')</th>
</tr>
</thead>
<tbody>
<tr>
<td align="right">2005</td>
<td align="right">8492</td>
<td align="right">12104</td>
<td align="right">12104</td>
<td align="left">A</td>
</tr>
<tr>
<td align="right">2006</td>
<td align="right">8492</td>
<td align="right">12256</td>
<td align="right">12256</td>
<td align="left">A</td>
</tr>
<tr>
<td align="right">2007</td>
<td align="right">8492</td>
<td align="right">14976</td>
<td align="right">14976</td>
<td align="left">A</td>
</tr>
<tr>
<td align="right">2008</td>
<td align="right">14063</td>
<td align="right">17523</td>
<td align="right">17523</td>
<td align="left">A*</td>
</tr>
<tr>
<td align="right">2009</td>
<td align="right">17155</td>
<td align="right">16815</td>
<td align="right">16815</td>
<td align="left">A</td>
</tr>
</tbody>
</table>
<p><br></p>
<p>We'll quickly visualise the cumulative excess emissions for the account we've just retrieved.</p>
<p>When the cumulative emissions are below 0 we can imagine the account as being in credit, whereas when its above 0 we can view it as being in debt.</p>
<div class="highlight"><pre><span></span><code><span class="n">df_plot</span> <span class="o">=</span> <span class="n">df_compliance</span><span class="p">[[</span><span class="s1">&#39;allocated_allowances&#39;</span><span class="p">,</span> <span class="s1">&#39;verified_emissions&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;Int64&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
<span class="n">df_plot</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># Plotting</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

<span class="p">(</span><span class="n">df_plot</span><span class="p">[</span><span class="s1">&#39;verified_emissions&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">df_plot</span><span class="p">[</span><span class="s1">&#39;allocated_allowances&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">df_plot</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;k--&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Account ID: </span><span class="si">{</span><span class="n">account_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Excess Emissions&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="n">hlp</span><span class="o">.</span><span class="n">hide_spines</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
</code></pre></div>
<p><img alt="png" src="../img/nbs/output_28_0.png" /></p>
<p><br></p>
<p>We'll take a quick look at how well the tables can be parsed into dataframes using <code>pd.read_html</code> alone</p>
<div class="highlight"><pre><span></span><code><span class="n">_</span> <span class="p">,</span> <span class="n">df_master_general_info</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">df_contact_info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">operator_master_table</span><span class="p">))</span>
<span class="n">_</span> <span class="p">,</span> <span class="n">df_child_general_info</span><span class="p">,</span> <span class="n">df_address_info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">operator_child_table</span><span class="p">))</span>

<span class="n">df_master_general_info</span>
</code></pre></div>
<table>
<thead>
<tr>
<th align="right"></th>
<th align="left">0</th>
<th align="left">1</th>
<th align="left">2</th>
<th align="left">3</th>
<th align="left">4</th>
<th align="left">5</th>
<th align="left">6</th>
</tr>
</thead>
<tbody>
<tr>
<td align="right">0</td>
<td align="left">General Information</td>
<td align="left">General Information</td>
<td align="left">General Information</td>
<td align="left">General Information</td>
<td align="left">General Information</td>
<td align="left">General Information</td>
<td align="left">General Information</td>
</tr>
<tr>
<td align="right">1</td>
<td align="left">National Administrator</td>
<td align="left">Account Type</td>
<td align="left">Account Holder Name</td>
<td align="left">Installation ID</td>
<td align="left">Company Registration No</td>
<td align="left">Account Status</td>
<td align="left">nan</td>
</tr>
<tr>
<td align="right">2</td>
<td align="left">Austria</td>
<td align="left">100-Holding Account</td>
<td align="left">Breitenfeld Edelstahl AG</td>
<td align="left">2</td>
<td align="left">FN 74471 t</td>
<td align="left">open</td>
<td align="left">nan</td>
</tr>
</tbody>
</table>
<p><br></p>
<p>We'll create some helper functions for extracting data from the different tables individually</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="n">extract_single_row_table_info</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">df_info</span><span class="p">,</span> <span class="n">num_excess_start_cols</span><span class="p">,</span> <span class="n">last_end_col</span><span class="p">:</span> <span class="n">df_info</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">num_excess_start_cols</span><span class="p">:,</span> <span class="p">:</span><span class="n">last_end_col</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

<span class="n">extract_master_general_info</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">df_master_general_info</span><span class="p">:</span> <span class="n">extract_single_row_table_info</span><span class="p">(</span><span class="n">df_master_general_info</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">extract_child_general_info</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">df_child_general_info</span><span class="p">:</span> <span class="n">extract_single_row_table_info</span><span class="p">(</span><span class="n">df_child_general_info</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">extract_contact_info</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">df_contact_info</span><span class="p">:</span> <span class="n">extract_single_row_table_info</span><span class="p">(</span><span class="n">df_contact_info</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
<span class="n">extract_address_info</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">df_address_info</span><span class="p">:</span> <span class="n">extract_single_row_table_info</span><span class="p">(</span><span class="n">df_address_info</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">extract_aircraft_master_general_info</span><span class="p">(</span><span class="n">df_master_general_info</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>{&#39;National Administrator&#39;: &#39;Austria&#39;,
 &#39;Account Type&#39;: &#39;100-Holding Account&#39;,
 &#39;Account Holder Name&#39;: &#39;Breitenfeld Edelstahl AG&#39;,
 &#39;Installation ID&#39;: &#39;2&#39;,
 &#39;Company Registration No&#39;: &#39;FN 74471 t&#39;,
 &#39;Account Status&#39;: &#39;open&#39;}
</code></pre></div>
<p><br></p>
<p>We'll now repeat this for all four of the table types and then combine them in a single dictionary</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">clean_dict_2nd_level_nulls</span><span class="p">(</span><span class="n">dict_</span><span class="p">):</span>
    <span class="n">dict_</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">k1</span><span class="p">:</span> <span class="p">{</span>
            <span class="n">k2</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">v2</span>
                <span class="k">if</span> <span class="n">v2</span>
                <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;nan&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">]</span> 
                <span class="k">else</span> <span class="kc">None</span>
               <span class="p">)</span>
            <span class="k">for</span> <span class="n">k2</span><span class="p">,</span> <span class="n">v2</span>
            <span class="ow">in</span> <span class="n">v1</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span> 
        <span class="k">for</span> <span class="n">k1</span><span class="p">,</span> <span class="n">v1</span> 
        <span class="ow">in</span> <span class="n">dict_</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">dict_</span>

<span class="k">def</span> <span class="nf">extract_page_info</span><span class="p">(</span>
    <span class="n">account_id</span><span class="p">,</span> 
    <span class="n">master_general_info_func</span><span class="o">=</span><span class="n">extract_master_general_info</span><span class="p">,</span>
    <span class="n">child_general_info_func</span><span class="o">=</span><span class="n">extract_child_general_info</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1"># Retrieving table html</span>
    <span class="n">account_url</span> <span class="o">=</span> <span class="n">account_id_to_url</span><span class="p">(</span><span class="n">account_id</span><span class="p">)</span>
    <span class="n">operator_master_table</span><span class="p">,</span> <span class="n">operator_child_table</span><span class="p">,</span> <span class="n">compliance_table</span> <span class="o">=</span> <span class="n">extract_key_table_soups</span><span class="p">(</span><span class="n">account_url</span><span class="p">)</span>

    <span class="c1"># Extracting raw dataframes</span>
    <span class="n">_</span> <span class="p">,</span> <span class="n">df_master_general_info</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">df_contact_info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">operator_master_table</span><span class="p">))</span>
    <span class="n">_</span> <span class="p">,</span> <span class="n">df_child_general_info</span><span class="p">,</span> <span class="n">df_address_info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">operator_child_table</span><span class="p">))</span>

    <span class="c1"># Parsing to clean dictionaries</span>
    <span class="n">master_general_info</span> <span class="o">=</span> <span class="n">master_general_info_func</span><span class="p">(</span><span class="n">df_master_general_info</span><span class="p">)</span>
    <span class="n">child_general_info</span> <span class="o">=</span> <span class="n">child_general_info_func</span><span class="p">(</span><span class="n">df_child_general_info</span><span class="p">)</span>
    <span class="n">contact_info</span> <span class="o">=</span> <span class="n">extract_contact_info</span><span class="p">(</span><span class="n">df_contact_info</span><span class="p">)</span>
    <span class="n">address_info</span> <span class="o">=</span> <span class="n">extract_address_info</span><span class="p">(</span><span class="n">df_address_info</span><span class="p">)</span>

    <span class="c1"># Collating data</span>
    <span class="n">page_info</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;master_general_info&#39;</span><span class="p">:</span> <span class="n">master_general_info</span><span class="p">,</span>
        <span class="s1">&#39;child_general_info&#39;</span><span class="p">:</span> <span class="n">child_general_info</span><span class="p">,</span>
        <span class="s1">&#39;contact_info&#39;</span><span class="p">:</span> <span class="n">contact_info</span><span class="p">,</span>
        <span class="s1">&#39;address_info&#39;</span><span class="p">:</span> <span class="n">address_info</span>
    <span class="p">}</span>

    <span class="c1"># Cleaning null values</span>
    <span class="n">page_info</span> <span class="o">=</span> <span class="n">clean_dict_2nd_level_nulls</span><span class="p">(</span><span class="n">page_info</span><span class="p">)</span>

    <span class="c1"># Extracting time-series data</span>
    <span class="n">df_ts</span> <span class="o">=</span> <span class="n">extract_compliance_df</span><span class="p">(</span><span class="n">compliance_table</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">page_info</span><span class="p">,</span> <span class="n">df_ts</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">aircraft_page_info</span><span class="p">,</span> <span class="n">df_ts</span> <span class="o">=</span> <span class="n">extract_page_info</span><span class="p">(</span><span class="n">account_id</span><span class="p">)</span>

<span class="n">JSON</span><span class="p">(</span><span class="n">aircraft_page_info</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&lt;IPython.core.display.JSON object&gt;
</code></pre></div>
<p><br></p>
<p>We can use the same function to extract the information from an installation page as well.</p>
<p>N.b. this is only possible because the tables are of the same size and format, if this changes in future the aircraft and installation pages will need separate extraction functions</p>
<div class="highlight"><pre><span></span><code><span class="n">account_id</span> <span class="o">=</span> <span class="n">df_search</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_search</span><span class="p">[</span><span class="s1">&#39;account_type&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Operator Holding Account&#39;</span><span class="p">,</span> <span class="s1">&#39;account_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">page_info</span><span class="p">,</span> <span class="n">df_ts</span> <span class="o">=</span> <span class="n">extract_page_info</span><span class="p">(</span><span class="n">account_id</span><span class="p">)</span>

<span class="n">JSON</span><span class="p">(</span><span class="n">installation_page_info</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&lt;IPython.core.display.JSON object&gt;
</code></pre></div>
<p><br></p>
<p>We'll quickly write some helper functions for collating this data in separate owner and unit dictionaries</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">collate_owner_info</span><span class="p">(</span><span class="n">installation_page_info</span><span class="p">):</span>
    <span class="n">general_info</span> <span class="o">=</span> <span class="n">installation_page_info</span><span class="p">[</span><span class="s1">&#39;master_general_info&#39;</span><span class="p">]</span>
    <span class="n">contact_info</span> <span class="o">=</span> <span class="n">installation_page_info</span><span class="p">[</span><span class="s1">&#39;contact_info&#39;</span><span class="p">]</span>

    <span class="n">owner_info</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">general_info</span><span class="p">)</span>
    <span class="n">owner_info</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">contact_info</span><span class="p">))</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">general_info</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">contact_info</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">owner_info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;There are duplicate entries in the dictionary keys&#39;</span>

    <span class="k">return</span> <span class="n">owner_info</span>

<span class="k">def</span> <span class="nf">collate_unit_info</span><span class="p">(</span><span class="n">installation_page_info</span><span class="p">):</span>
    <span class="n">general_info</span> <span class="o">=</span> <span class="n">installation_page_info</span><span class="p">[</span><span class="s1">&#39;child_general_info&#39;</span><span class="p">]</span>
    <span class="n">address_info</span> <span class="o">=</span> <span class="n">installation_page_info</span><span class="p">[</span><span class="s1">&#39;address_info&#39;</span><span class="p">]</span>

    <span class="n">installation_info</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">general_info</span><span class="p">)</span>
    <span class="n">installation_info</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">address_info</span><span class="p">))</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">general_info</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">address_info</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">installation_info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;There are duplicate entries in the dictionary keys&#39;</span>

    <span class="k">return</span> <span class="n">installation_info</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">s_owner_info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">collate_owner_info</span><span class="p">(</span><span class="n">page_info</span><span class="p">))</span>
<span class="n">s_installation_info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">collate_unit_info</span><span class="p">(</span><span class="n">page_info</span><span class="p">))</span>

<span class="n">s_owner_info</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>National Administrator                           Austria
Account Type                         100-Holding Account
Account Holder Name        Jetalliance Flugbetriebs GmbH
Aircraft Operator ID                              200103
Company Registration No                       FN 203001g
Account Status                                    closed
Type                                      Account holder
Name                       Jetalliance Flugbetriebs GmbH
Legal Entity Identifier                             None
Main Address Line                            Flugplatz 1
Secondary Address Line                              None
Postal Code                                         2542
City                                        Kottingbrunn
Country                                          Austria
Telephone 1                                         None
Telephone 2                                         None
E-Mail Address                                      None
dtype: object
</code></pre></div>
<p><br></p>
<p>We'll create a wrapper for downloading and saving the installation data</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">construct_ets_unit_dfs</span><span class="p">(</span><span class="n">account_ids</span><span class="p">,</span> <span class="n">owners_col_rename_map</span><span class="p">,</span> <span class="n">units_col_rename_map</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">df_owners</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">account_ids</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">owners_col_rename_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">df_units</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">account_ids</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">units_col_rename_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">ts_dfs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">account_id</span> <span class="ow">in</span> <span class="n">track</span><span class="p">(</span><span class="n">account_ids</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">):</span>
        <span class="n">page_info</span><span class="p">,</span> <span class="n">df_ts</span> <span class="o">=</span> <span class="n">extract_page_info</span><span class="p">(</span><span class="n">account_id</span><span class="p">)</span>

        <span class="n">df_owners</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">account_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">collate_owner_info</span><span class="p">(</span><span class="n">page_info</span><span class="p">))</span>
        <span class="n">df_units</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">account_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">collate_unit_info</span><span class="p">(</span><span class="n">page_info</span><span class="p">))</span>
        <span class="n">ts_dfs</span><span class="p">[</span><span class="n">account_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_ts</span>

    <span class="n">df_owners</span> <span class="o">=</span> <span class="n">df_owners</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">owners_col_rename_map</span><span class="p">)</span>
    <span class="n">df_units</span> <span class="o">=</span> <span class="n">df_units</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">units_col_rename_map</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_owners</span><span class="p">,</span> <span class="n">df_units</span><span class="p">,</span> <span class="n">ts_dfs</span>

<span class="k">def</span> <span class="nf">constuct_da_ts_from_ts_dfs</span><span class="p">(</span><span class="n">ts_dfs</span><span class="p">):</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">df</span><span class="o">.</span><span class="n">values</span> <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">ts_dfs</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>

    <span class="n">coords</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;account_id&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">ts_dfs</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> 
        <span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">ts_dfs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
        <span class="s1">&#39;variable&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">ts_dfs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
    <span class="p">}</span>

    <span class="n">da_ts</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">coords</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">da_ts</span>

<span class="k">def</span> <span class="nf">ts_dfs_to_separate_vars</span><span class="p">(</span><span class="n">ts_dfs</span><span class="p">):</span>
    <span class="n">da_ts</span> <span class="o">=</span> <span class="n">constuct_da_ts_from_ts_dfs</span><span class="p">(</span><span class="n">ts_dfs</span><span class="p">)</span>
    <span class="n">ts_var_dfs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">da_ts</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
        <span class="n">ts_var_dfs</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">da_ts</span>
                                <span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">variable</span><span class="o">=</span><span class="n">variable</span><span class="p">)</span>
                                <span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">variable</span><span class="p">)</span>
                                <span class="p">[</span><span class="n">variable</span><span class="p">]</span>
                                <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                                <span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s1">&#39;account_id&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="n">variable</span><span class="p">)</span>
                               <span class="p">)</span>

    <span class="k">return</span> <span class="n">ts_var_dfs</span>

<span class="k">def</span> <span class="nf">construct_installation_dfs</span><span class="p">(</span><span class="n">account_ids</span><span class="p">):</span>
    <span class="n">installation_owners_col_rename_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;National Administrator&#39;</span><span class="p">:</span> <span class="s1">&#39;national_administrator&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Account Type&#39;</span><span class="p">:</span> <span class="s1">&#39;account_type&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Account Holder Name&#39;</span><span class="p">:</span> <span class="s1">&#39;account_holder_name&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Installation ID&#39;</span><span class="p">:</span> <span class="s1">&#39;installation_id&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Company Registration No&#39;</span><span class="p">:</span> <span class="s1">&#39;company_registration_number&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Account Status&#39;</span><span class="p">:</span> <span class="s1">&#39;account_status&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Type&#39;</span><span class="p">:</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Legal Entity Identifier&#39;</span><span class="p">:</span> <span class="s1">&#39;legal_entity_identifier&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Main Address Line&#39;</span><span class="p">:</span> <span class="s1">&#39;first_address_line&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Secondary Address Line&#39;</span><span class="p">:</span> <span class="s1">&#39;second_address_line&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Postal Code&#39;</span><span class="p">:</span> <span class="s1">&#39;postcode&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;City&#39;</span><span class="p">:</span> <span class="s1">&#39;city&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Country&#39;</span><span class="p">:</span> <span class="s1">&#39;country&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Telephone 1&#39;</span><span class="p">:</span> <span class="s1">&#39;telephone_1&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Telephone 2&#39;</span><span class="p">:</span> <span class="s1">&#39;telephone_2&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;E-Mail Address&#39;</span><span class="p">:</span> <span class="s1">&#39;email&#39;</span>
    <span class="p">}</span>

    <span class="n">installations_col_rename_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Installation ID&#39;</span><span class="p">:</span> <span class="s1">&#39;installation_id&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Installation Name&#39;</span><span class="p">:</span> <span class="s1">&#39;installation_name&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Permit ID&#39;</span><span class="p">:</span> <span class="s1">&#39;permit_id&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Permit Entry Date&#39;</span><span class="p">:</span> <span class="s1">&#39;permit_entry_date&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Permit Expiry/Revocation Date&#39;</span><span class="p">:</span> <span class="s1">&#39;permit_expiration_Date&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Name of Subsidiary undertaking&#39;</span><span class="p">:</span> <span class="s1">&#39;subsidiary_undertaking_name&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Name of Parent undertaking&#39;</span><span class="p">:</span> <span class="s1">&#39;parent_undertaking_name&#39;</span><span class="p">,</span>
        <span class="s1">&#39;E-PRTR identification&#39;</span><span class="p">:</span> <span class="s1">&#39;EPRTR_id&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;First Year of Emissions&#39;</span><span class="p">:</span> <span class="s1">&#39;initial_emissions_year&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Last Year of Emissions&#39;</span><span class="p">:</span> <span class="s1">&#39;final_emissions_year&#39;</span><span class="p">,</span>  
        <span class="s1">&#39;Main Address Line&#39;</span><span class="p">:</span> <span class="s1">&#39;first_address_line&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Secondary Address Line&#39;</span><span class="p">:</span> <span class="s1">&#39;second_address_line&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Postal Code&#39;</span><span class="p">:</span> <span class="s1">&#39;postcode&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;City&#39;</span><span class="p">:</span> <span class="s1">&#39;city&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Country&#39;</span><span class="p">:</span> <span class="s1">&#39;country&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Latitude&#39;</span><span class="p">:</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Longitude&#39;</span><span class="p">:</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Main Activity&#39;</span><span class="p">:</span> <span class="s1">&#39;main_activity&#39;</span>
    <span class="p">}</span>

    <span class="n">df_owners</span><span class="p">,</span> <span class="n">df_installations</span><span class="p">,</span> <span class="n">ts_dfs</span> <span class="o">=</span> <span class="n">construct_ets_unit_dfs</span><span class="p">(</span><span class="n">account_ids</span><span class="p">,</span> <span class="n">installation_owners_col_rename_map</span><span class="p">,</span> <span class="n">installations_col_rename_map</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Installations&#39;</span><span class="p">)</span>
    <span class="n">installation_dfs</span> <span class="o">=</span> <span class="n">ts_dfs_to_separate_vars</span><span class="p">(</span><span class="n">ts_dfs</span><span class="p">)</span>

    <span class="n">installation_dfs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="s1">&#39;owners&#39;</span><span class="p">:</span> <span class="n">df_owners</span><span class="p">,</span>
        <span class="s1">&#39;installations&#39;</span><span class="p">:</span> <span class="n">df_installations</span>
    <span class="p">})</span>

    <span class="k">return</span> <span class="n">installation_dfs</span>

<span class="k">def</span> <span class="nf">get_installation_dfs</span><span class="p">(</span><span class="n">df_search</span><span class="p">,</span> <span class="n">data_dir</span><span class="o">=</span><span class="s1">&#39;data/installations&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">df_search_installations</span> <span class="o">=</span> <span class="n">df_search</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;account_type==&#39;Operator Holding Account&#39;&quot;</span><span class="p">)</span>
    <span class="n">account_ids</span> <span class="o">=</span> <span class="n">df_search_installations</span><span class="p">[</span><span class="s1">&#39;account_id&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">redownload</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">installation_dfs</span> <span class="o">=</span> <span class="n">construct_installation_dfs</span><span class="p">(</span><span class="n">account_ids</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">df_installation</span> <span class="ow">in</span> <span class="n">installation_dfs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">df_installation</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">.csv&#39;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">installation_dfs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;.csv&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="n">installation_dfs</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">.csv&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">installation_dfs</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">redownload_installations</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">installation_dfs</span> <span class="o">=</span> <span class="n">get_installation_dfs</span><span class="p">(</span><span class="n">df_search</span><span class="p">,</span> <span class="n">data_dir</span><span class="o">=</span><span class="s1">&#39;../data/installations&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="n">redownload_installations</span><span class="p">)</span>

<span class="n">installation_dfs</span><span class="p">[</span><span class="s1">&#39;owners&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</code></pre></div>
<div><span class="Text-label" style="display:inline-block; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; min-width:0; max-width:15ex; vertical-align:middle; text-align:right"></span>
<progress style="width:60ex" max="16040" value="16040" class="Progress-main"/></progress>
<span class="Progress-label"><strong>100%</strong></span>
<span class="Iteration-label">16000/16040</span>
<span class="Time-label">[02:20:00<00:00, 0.52s/it]</span></div>

<div class="highlight"><pre><span></span><code>(16040, 17)
</code></pre></div>
<p><br></p>
<p>We can do the same for the aircraft data as well</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">construct_aircraft_dfs</span><span class="p">(</span><span class="n">account_ids</span><span class="p">):</span>
    <span class="n">aircraft_owners_col_rename_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;National Administrator&#39;</span><span class="p">:</span> <span class="s1">&#39;national_administrator&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Account Type&#39;</span><span class="p">:</span> <span class="s1">&#39;account_type&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Account Holder Name&#39;</span><span class="p">:</span> <span class="s1">&#39;account_holder_name&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Aircraft Operator ID&#39;</span><span class="p">:</span> <span class="s1">&#39;aircraft_operator_id&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Company Registration No&#39;</span><span class="p">:</span> <span class="s1">&#39;company_registration_number&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Account Status&#39;</span><span class="p">:</span> <span class="s1">&#39;account_status&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Type&#39;</span><span class="p">:</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Legal Entity Identifier&#39;</span><span class="p">:</span> <span class="s1">&#39;legal_entity_identifier&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Main Address Line&#39;</span><span class="p">:</span> <span class="s1">&#39;first_address_line&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Secondary Address Line&#39;</span><span class="p">:</span> <span class="s1">&#39;second_address_line&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Postal Code&#39;</span><span class="p">:</span> <span class="s1">&#39;postcode&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;City&#39;</span><span class="p">:</span> <span class="s1">&#39;city&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Country&#39;</span><span class="p">:</span> <span class="s1">&#39;country&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Telephone 1&#39;</span><span class="p">:</span> <span class="s1">&#39;telephone_1&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Telephone 2&#39;</span><span class="p">:</span> <span class="s1">&#39;telephone_2&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;E-Mail Address&#39;</span><span class="p">:</span> <span class="s1">&#39;email&#39;</span>
    <span class="p">}</span>

    <span class="n">aircraft_col_rename_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Aircraft Operator ID&#39;</span><span class="p">:</span> <span class="s1">&#39;aircraft_operator_id&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Unique Code under Commission Regulation (EC) No 748/2009&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Monitoring Plan ID&#39;</span><span class="p">:</span> <span class="s1">&#39;monitoring_plan_id&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Monitoring plan — first year of applicability&#39;</span><span class="p">:</span> <span class="s1">&#39;monitoring_plan_start_date&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Monitoring plan — year of expiry&#39;</span><span class="p">:</span> <span class="s1">&#39;monitoring_plan_expiration_Date&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Name of Subsidiary undertaking&#39;</span><span class="p">:</span> <span class="s1">&#39;subsidiary_undertaking_name&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Name of Parent undertaking&#39;</span><span class="p">:</span> <span class="s1">&#39;parent_undertaking_name&#39;</span><span class="p">,</span>
        <span class="s1">&#39;E-PRTR identification&#39;</span><span class="p">:</span> <span class="s1">&#39;EPRTR_id&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Call Sign (ICAO designator)&#39;</span><span class="p">:</span> <span class="s1">&#39;call_sign&#39;</span><span class="p">,</span>
        <span class="s1">&#39;First Year of Emissions&#39;</span><span class="p">:</span> <span class="s1">&#39;initial_emissions_year&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Main Address Line&#39;</span><span class="p">:</span> <span class="s1">&#39;first_address_line&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Secondary Address Line&#39;</span><span class="p">:</span> <span class="s1">&#39;second_address_line&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Postal Code&#39;</span><span class="p">:</span> <span class="s1">&#39;postcode&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;City&#39;</span><span class="p">:</span> <span class="s1">&#39;city&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Country&#39;</span><span class="p">:</span> <span class="s1">&#39;country&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Latitude&#39;</span><span class="p">:</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Longitude&#39;</span><span class="p">:</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Main Activity&#39;</span><span class="p">:</span> <span class="s1">&#39;main_activity&#39;</span>
    <span class="p">}</span>

    <span class="n">df_owners</span><span class="p">,</span> <span class="n">df_aircraft</span><span class="p">,</span> <span class="n">ts_dfs</span> <span class="o">=</span> <span class="n">construct_ets_unit_dfs</span><span class="p">(</span><span class="n">account_ids</span><span class="p">,</span> <span class="n">aircraft_owners_col_rename_map</span><span class="p">,</span> <span class="n">aircraft_col_rename_map</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Aircraft&#39;</span><span class="p">)</span>
    <span class="n">aircraft_dfs</span> <span class="o">=</span> <span class="n">ts_dfs_to_separate_vars</span><span class="p">(</span><span class="n">ts_dfs</span><span class="p">)</span>

    <span class="n">aircraft_dfs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="s1">&#39;owners&#39;</span><span class="p">:</span> <span class="n">df_owners</span><span class="p">,</span>
        <span class="s1">&#39;aircraft&#39;</span><span class="p">:</span> <span class="n">df_aircraft</span>
    <span class="p">})</span>

    <span class="k">return</span> <span class="n">aircraft_dfs</span>

<span class="k">def</span> <span class="nf">get_aircraft_dfs</span><span class="p">(</span><span class="n">df_search</span><span class="p">,</span> <span class="n">data_dir</span><span class="o">=</span><span class="s1">&#39;data/aircraft&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">df_search_aircraft</span> <span class="o">=</span> <span class="n">df_search</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;account_type==&#39;Aircraft Operator Account&#39;&quot;</span><span class="p">)</span>
    <span class="n">account_ids</span> <span class="o">=</span> <span class="n">df_search_aircraft</span><span class="p">[</span><span class="s1">&#39;account_id&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>

    <span class="n">redownload_aircraft</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">redownload_aircraft</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">aircraft_dfs</span> <span class="o">=</span> <span class="n">construct_aircraft_dfs</span><span class="p">(</span><span class="n">account_ids</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">df_aircraft</span> <span class="ow">in</span> <span class="n">aircraft_dfs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">df_aircraft</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">.csv&#39;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">aircraft_dfs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;.csv&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="n">aircraft_dfs</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">.csv&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">aircraft_dfs</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">redownload_aircraft</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">aircraft_dfs</span> <span class="o">=</span> <span class="n">get_aircraft_dfs</span><span class="p">(</span><span class="n">df_search</span><span class="p">,</span> <span class="n">data_dir</span><span class="o">=</span><span class="s1">&#39;../data/aircraft&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="n">redownload_aircraft</span><span class="p">)</span>

<span class="n">aircraft_dfs</span><span class="p">[</span><span class="s1">&#39;owners&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</code></pre></div>
<div><span class="Text-label" style="display:inline-block; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; min-width:0; max-width:15ex; vertical-align:middle; text-align:right"></span>
<progress style="width:60ex" max="1580" value="1580" class="Progress-main"/></progress>
<span class="Progress-label"><strong>100%</strong></span>
<span class="Iteration-label">1575/1580</span>
<span class="Time-label">[14:53<00:01, 0.57s/it]</span></div>

<div class="highlight"><pre><span></span><code>(1580, 17)
</code></pre></div>
<p><br></p>
<h3 id="putting-it-all-together">Putting It All Together<a class="headerlink" href="#putting-it-all-together" title="Permanent link">&para;</a></h3>
<p>Finally we'll finish by creating a wrapper that downloads all of the data to the specified directory</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">redownload_all_data</span><span class="p">(</span><span class="n">data_dir</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">):</span>
    <span class="n">all_dfs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">all_dfs</span><span class="p">[</span><span class="s1">&#39;account_search&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_search_df</span><span class="p">(</span><span class="n">data_dir</span><span class="o">=</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">installation_dfs</span> <span class="o">=</span> <span class="n">get_installation_dfs</span><span class="p">(</span><span class="n">all_dfs</span><span class="p">[</span><span class="s1">&#39;account_search&#39;</span><span class="p">],</span> <span class="n">data_dir</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data_dir</span><span class="si">}</span><span class="s1">/installations&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">aircraft_dfs</span> <span class="o">=</span> <span class="n">get_aircraft_dfs</span><span class="p">(</span><span class="n">all_dfs</span><span class="p">[</span><span class="s1">&#39;account_search&#39;</span><span class="p">],</span> <span class="n">data_dir</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data_dir</span><span class="si">}</span><span class="s1">/aircraft&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">all_dfs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">installation_dfs</span><span class="p">)</span>
    <span class="n">all_dfs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">aircraft_dfs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">all_dfs</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">redownload_everything</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">if</span> <span class="n">redownload_everything</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">all_dfs</span> <span class="o">=</span> <span class="n">redownload_all_data</span><span class="p">(</span><span class="n">data_dir</span><span class="o">=</span><span class="s1">&#39;../data&#39;</span><span class="p">)</span>
</code></pre></div>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        <a href="../02-installation-allocations/" class="md-footer__link md-footer__link--prev" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Installations
            </div>
          </div>
        </a>
      
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["header.autohide", "navigation.tabs", "navigation.instant", "search.suggest"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../assets/javascripts/workers/search.fe42c31b.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.4ea5477f.min.js"></script>
      
    
  </body>
</html>